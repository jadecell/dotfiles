#!/usr/bin/env sh
set -eu

if [ -x /usr/bin/pacman ]; then
	printf 'Beginning upgrade.\n'
    paru -Syu
    pkill -RTMIN+8 "dwmblocks"
    printf '\nUpgrade complete.\nPress \033[0;32m<Enter>\033[0m to exit window.\n\n'
    read -r _
else
    # Run the current script as root with all the arguments if not already being ran as root
    if [ "$(id -u)" -ne "0" ]; then exec sudo "$0" "$@"; fi

	printf 'Beginning upgrade.\n'
    eix-sync

    clear
    emerge -auDU --with-bdeps=y @world

	if [ "$(eselect kernel list | wc -l)" -gt "1" ]; then
		CURRENTKERNELVERSION="$(uname -r | tr '-' ' ' | cut -d' ' -f1)"
		NEWKERNELVERSION="$(eselect kernel list | tail -1 | cut -d'-' -f2)"
		eselect kernel set "linux-${NEWKERNELVERSION}-gentoo-dist"

		rm -rf "/boot/*${CURRENTKERNELVERSION:?}*"
		emerge -c "=sys-kernel/gentoo-kernel-bin-${CURRENTKERNELVERSION}"
		grub-mkconfig -o /boot/grub/grub.cfg
	fi

    printf '\nUpgrade complete.\nPress \033[0;32m<Enter>\033[0m to exit window.\n\n'
    read -r _
fi
