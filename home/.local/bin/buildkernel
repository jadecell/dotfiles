#!/usr/bin/env bash

[ "$EUID" -ne "0" ] && echo "Please re-run this script as root!" && exit 1

CPUTHREADS=$(grep -c processor /proc/cpuinfo)
CPUTHREADSPLUSONE=$((CPUTHREADS + 1))
KERNELCONFIGLOCATION="/usr/src/linux/.config"
KERNELCONFIGDIRECTORY="$(echo $KERNELCONFIGLOCATION | cut -d'.' -f1)"
KERNELCONFIGDESTINATION="/home/jackson/.local/repos/dotfiles/extra/kernelconfigs"
NEWKERNELVERSION="$(eselect kernel list | tail -1 | cut -d'-' -f2)"
CURRENTKERNELVERSION="$(uname -r | tr '-' ' ' | cut -d' ' -f1)"

if [ "$NEWKERNELVERSION" != "$CURRENTKERNELVERSION" ]; then
    eselect kernel set "linux-$NEWKERNELVERSION-gentoo"
    cd "$KERNELCONFIGDIRECTORY" || exit 1
    make mrproper
    cp "$KERNELCONFIGDESTINATION/$CURRENTKERNELVERSION-gentoo-$(hostname).config" "$KERNELCONFIGLOCATION"
    make olddefconfig
fi

cd "$KERNELCONFIGDIRECTORY" && make menuconfig

clear
read -r -p "Want to build the newly configured kernel [y/n]? " BUILDNEWKERNEL

{ [ "$BUILDNEWKERNEL" = "y" ] || [ "$BUILDNEWKERNEL" = "Y" ]; } && make -j$CPUTHREADSPLUSONE && make modules_install install && genkernel --install --kernel-config=$KERNELCONFIGLOCATION initramfs

BUILTKERNELVERSION="$(grep 'Linux/x86' $KERNELCONFIGLOCATION | tr '-' ' ' | cut -d' ' -f3)"
cp -f $KERNELCONFIGLOCATION "${KERNELCONFIGDESTINATION}/${BUILTKERNELVERSION}-gentoo-$(hostname).config"

clear
read -r -p "Want to remove duplicate kernel image [y/n]? " REMOVEDUPLICATEIMAGE
{ [ "$REMOVEDUPLICATEIMAGE" = "y" ] || [ "$REMOVEDUPLICATEIMAGE" = "Y" ]; } && rm -f /boot/*.old

clear
read -r -p "Want to re-build modules [y/n]? " REBUILDMODULES
{ [ "$REBUILDMODULES" = "y" ] || [ "$REBUILDMODULES" = "Y" ]; } && emerge @module-rebuild

if [ "$(find /boot -name 'vmlinuz*' | wc -l)" -gt "1" ]; then
    clear
    read -r -p "Want to remove old kernel files in /boot [y/n]? " REMOVEOLDKERNELFILES
    { [ "$REMOVEOLDKERNELFILES" = "y" ] || [ "$REMOVEOLDKERNELFILES" = "Y" ]; } && rm -f /boot/*"$CURRENTKERNELVERSION"*

    clear
    read -r -p "Want to remove the old kernel's ebuild [y/n]? " REMOVEOLDKERNELEBUILD
    { [ "$REMOVEOLDKERNELEBUILD" = "y" ] || [ "$REMOVEOLDKERNELEBUILD" = "Y" ]; } && emerge -cv "=sys-kernel/gentoo-sources-$CURRENTKERNELVERSION"
fi

clear
read -r -p "Re-generate grub config [y/n]? " GRUBCONFIG
{ [ "$GRUBCONFIG" = "y" ] || [ "$GRUBCONFIG" = "Y" ]; } && grub-mkconfig -o /boot/grub/grub.cfg

clear
read -r -p "Reboot now [y/n]? " REBOOTNOW
{ [ "$REBOOTNOW" = "y" ] || [ "$REBOOTNOW" = "Y" ]; } && reboot
